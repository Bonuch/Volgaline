<!DOCTYPE html>
<html {{ HTML_ATTRS }}>
<head {{ HEAD_ATTRS }}>

    {{ HEAD }}

    <script>
        // AdvCake
        window.advcake_data = window.advcake_data || [];
    </script>
    <meta name="env_mode" content="<%= process.env.NODE_ENV %>"/>
    <% if (process.env.ENABLE_METRICS === 'yes') { %>
        <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
        <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
        <link rel="preconnect" href="http://code.acstat.com" crossorigin>
        <link rel="preconnect" href="https://mod.calltouch.ru" crossorigin>
        <link rel="preconnect" href="https://static.saas-support.com" crossorigin>

        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-T429SWV');</script>
        <!-- End Google Tag Manager -->

        <!-- Yandex.Metrika counter -->
        <script>
            (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
                m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
            (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
            ym(35357505, "init", {
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true,
                webvisor:true,
                trackHash:true
            });
        </script>
        <noscript><div><img src="https://mc.yandex.ru/watch/35357505" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
        <!-- /Yandex.Metrika counter -->
        <!-- calltouch -->
        <script>
            (function(w,d,n,c){w.CalltouchDataObject=n;w[n]=function(){w[n]["callbacks"].push(arguments)};if(!w[n]["callbacks"]){w[n]["callbacks"]=[]}w[n]["loaded"]=false;if(typeof c!=="object"){c=[c]}w[n]["counters"]=c;for(var i=0;i<c.length;i+=1){p(c[i])}function p(cId){var a=d.getElementsByTagName("script")[0],s=d.createElement("script"),i=function(){a.parentNode.insertBefore(s,a)};s.async=true;s.src="https://mod.calltouch.ru/init.js?id="+cId;if(w.opera=="[object Opera]"){d.addEventListener("DOMContentLoaded",i,false)}else{i()}}})(window,document,"ct","4erxoxif");
        </script>

        <script>
            (function ( a ) {
                var b = a.createElement("script");
                b.async = 1;
                b.src = "//code.acstat.com/";
                a=a.getElementsByTagName("script")[0]; a.parentNode.insertBefore(b,a)
            })(document);
        </script>
    <!-- VK -->
        <script>!function () {
            var t = document.createElement("script");
            t.type = "text/javascript", t.async = !0, t.src = 'https://vk.com/js/api/openapi.js?169', t.onload = function () {
                VK.Retargeting.Init("VK-RTRG-1342018-6ADwY"), VK.Retargeting.Hit()
            }, document.head.appendChild(t)
        }();</script>
        <noscript><img src="https://vk.com/rtrg?p=VK-RTRG-1342018-6ADwY" style="position:fixed; left:-999px;" alt=""/>
        </noscript>
    <% } %>

</head>
<body {{ BODY_ATTRS }}>

    <% if (process.env.ENABLE_METRICS === 'yes') { %>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T429SWV" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <% } %>

    {{ APP }}

    <% if (process.env.ENABLE_METRICS === 'yes') { %>
        <!-- Facebook Pixel Code -->
        <script>
            !function(f,b,e,v,n,t,s)
            {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                n.queue=[];t=b.createElement(e);t.async=!0;
                t.src=v;s=b.getElementsByTagName(e)[0];
                s.parentNode.insertBefore(t,s)}(window, document,'script',
                'https://connect.facebook.net/en_US/fbevents.js');
            fbq('init', '421534635113621');
            fbq('track', 'PageView');
        </script>
        <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=421534635113621&ev=PageView&noscript=1"/></noscript>
        <!-- End Facebook Pixel Code -->

        <script>
            if (!(window.location.search && window.location.search.indexOf('source=advcake') >= 0)) {
                // Envybox подключение по условию для Advcake
                document.write('<li'+'nk rel="stylesheet" hr'+'ef="https://cdn.envybox.io/widget/cbk.css"/>');
                document.write('<scr'+'ipt ty'+'pe="text/javascript" sr'+'c="https://cdn.envybox.io/widget/cbk.js?wcb_code=c17ff7058ae50b1350fb7ca375d207a0" cha'+'rset="UTF-8" as'+'ync></scr'+'ipt>');

                // аналогично для carrotquest
                const _carrotquestScript = '!function(){function t(t,e){return function(){window.carrotquestasync.push(t,arguments)}}if("undefined"==typeof carrotquest){var e=document.createElement("script");e.async=!0,e.src="//cdn.carrotquest.app/api.min.js",document.getElementsByTagName("head")[0].appendChild(e),window.carrotquest={},window.carrotquestasync=[],carrotquest.settings={};for(var n=["connect","track","identify","auth","oth","onReady","addCallback","removeCallback","trackMessageInteraction"],a=0;a<n.length;a++)carrotquest[n[a]]=t(n[a])}}(),carrotquest.connect("47687-36a3a9411184754f86f66f84a7");';
                document.write('<sc'+'ript as'+'ync>' + _carrotquestScript + '</scr'+'ipt>');
            }
        </script>

        <script>
            // calltouch api
            function __callTouchApi(data) {
                const SiteID = '43402';
                let ct_valid = !!data.fio && !!data.phoneNumber;
                if (!!ct_valid && window.ct_snd_flag != 1) {
                    window.ct_snd_flag = 1;
                    setTimeout(function(){ window.ct_snd_flag = 0; }, 20000);
                    Object.assign(data, {
                        requestUrl: location.href,
                        sessionId: window.call_value
                    });
                    const request = window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest();
                    const postData = Object.keys(data).reduce(function(a, k) {if(!!data[k]){a.push(k + '=' + encodeURIComponent(data[k]));}return a}, []).join('&');
                    const url = 'https://api.calltouch.ru/calls-service/RestAPI/requests/' + SiteID + '/register/';
                    request.open("POST", url, true);
                    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    request.send(postData);
                }
            }
            window.addEventListener('IWantToCruiseFormSent', function(event) {
                __callTouchApi({ fio: event.detail.name, phoneNumber: event.detail.phone, subject: event.detail.formTitle });
            });
            window.addEventListener('CallbackFormSent', function(event) {
                __callTouchApi({ fio: event.detail.name, phoneNumber: event.detail.phone, subject: event.detail.formTitle });
            });
            window.addEventListener('ICannotChoose', function(event) {
                __callTouchApi({ fio: event.detail.name, phoneNumber: event.detail.phone, subject: event.detail.formTitle });
            });
            window.addEventListener('OrderFormSent', function(event) {
                __callTouchApi({ fio: event.detail.customer.name, phoneNumber: event.detail.customer.phone, subject: event.detail.formTitle });
            });

            const send_ct_envybox = function(sub, data) {
                const fio = (!!data.info && !!data.info.name) ? data.info.name : data.name;
                const phone = (!!data.info && !!data.info.phone) ? data.info.phone : data.phone;
                const email = (!!data.info && !!data.info.email) ? data.info.email : data.email;
                __callTouchApi({ fio: fio, phoneNumber: phone, email: email, subject: sub });
            };
            window.ws_OnCallbackOnlineCall = function(data) { send_ct_envybox('Обратный звонок Envybox',data); }
            window.ws_OnCallbackDeferredCall = function(data) { send_ct_envybox('Обратный звонок Envybox',data); }
            window.ws_OnChatOfflineMessage = function(data) { send_ct_envybox('Оффлайн чат Envybox',data); }
            window.ws_OnChatVisitorIntroduced = function(data) { send_ct_envybox('Чат Envybox',data); }
            window.ws_OnQuizSendLead = function(data) { send_ct_envybox('Квиз Envybox',data); }
            window.ws_OnGeneratorSendLead = function(data) { send_ct_envybox('Генератор Envybox',data); }
            window.ws_OnChatFirstMessage = function(data) { window.ct('goal','envy_ms'); }

            window.carrotquest && window.carrotquest.addCallback('user_replied', function(data) {
                if (!window.ct_snd_flag){ window.ct_snd_flag = 1; ct('goal','cq_conversation'); }
            });

            Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(e){for(var t=this;t;){if(t.matches(e))return t;t=t.parentElement}return null});var ct_get_val=function(form,selector){if(!!form.querySelector(selector)){return form.querySelector(selector).value;}else{return '';}}

            var send_ct_carrotquest = function(sub, data) {
                if (!window.ct_send_flag){ window.ct_send_flag = 1
                    var fio = ''; var phone = ''; var email = '';
                    if (!!data.fio){fio = data.fio;} if (!!data.phone){phone = data.phone;} if (!!data.email){email = data.email;}
                    var ct_site_id = '43402';
                    var ct_data = { fio: fio, phoneNumber: phone, email: email, subject: sub, sessionId: window.call_value };
                    var request = window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest();
                    var post_data = Object.keys(ct_data).reduce(function(a, k) {if(!!ct_data[k]){a.push(k + '=' + encodeURIComponent(ct_data[k]));}return a}, []).join('&');
                    var url = 'https://api.calltouch.ru/calls-service/RestAPI/'+ct_site_id+'/requests/orders/register/';
                    if (!window.ct_snd_flag){
                        window.ct_snd_flag = 1; setTimeout(function(){ window.ct_snd_flag = 0; }, 20000);
                        request.open("POST", url, true); request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); request.send(post_data);
                    }
                }
            };

            window.carrotquest && window.carrotquest.addCallback('messenger_opened', function(e) {
                var iframe_chat = document.querySelector('#carrot-messenger-frame'); var iframe_chat_document;
                if (iframe_chat){
                    var iframe_chat_window = iframe_chat.contentWindow;
                    iframe_chat_document = iframe_chat.contentDocument || iframe_chat_window.document;
                }
                var iframe_popup = document.querySelector('#carrot-popup-frame'); var iframe_popup_document;
                if (iframe_popup){
                    var iframe_popup_window = iframe_popup.contentWindow;
                    iframe_popup_document = iframe_popup.contentDocument || iframe_popup_window.document;
                }
                var events = ['mousedown','touchstart']; events.forEach(function(ev) {
                    if (!!iframe_chat_document) {
                        iframe_chat_document.addEventListener(ev, function(e) {
                            if (e.target.closest('#carrotquest-messenger-innerreply-submit') || e.target.closest('#carrotquest-messenger-autoreply-request-ok')) {
                                var ct_data = {}; var cq_form = e.target.closest('#carrotquest-messenger');
                                ct_data.fio = ct_get_val(cq_form,'input[name="name"]');
                                ct_data.phone = ct_get_val(cq_form,'input[name="phone"]');
                                ct_data.email = ct_get_val(cq_form,'input[name="email"]');
                                ct_data.requestUrl = location.href;
                                if (!!ct_data.phone || !!ct_data.email){send_ct_carrotquest('Посетитель оставил контакты в Carrotquest',ct_data);}
                            }
                            if (e.target.closest('button[id*="block-popup-button"]')) {
                                var ct_data = {}; var cq_form = e.target.closest('#carrotquest-messenger');
                                ct_data.fio = ct_get_val(cq_form,'input[data-prop="$name"]');
                                ct_data.phone = ct_get_val(cq_form,'input[data-prop="$phone"]');
                                ct_data.email = ct_get_val(cq_form,'input[data-prop="$email"]');
                                ct_data.requestUrl = location.href;
                                if (!!ct_data.phone || !!ct_data.email){send_ct_carrotquest('Заявка из формы Carrotquest',ct_data);}
                            }
                        });
                    }
                    if (iframe_popup_document) {
                        iframe_popup_document.addEventListener(ev, function(e) {
                            if (e.target.closest('button[id*="block-popup-button"]')) {
                                var ct_data = {}; var cq_form = e.target.closest('#carrotquest-messenger');
                                ct_data.fio = ct_get_val(cq_form,'input[data-prop="$name"]');
                                ct_data.phone = ct_get_val(cq_form,'input[data-prop="$phone"]');
                                ct_data.email = ct_get_val(cq_form,'input[data-prop="$email"]');
                                ct_data.requestUrl = location.href;
                                if (!!ct_data.phone || !!ct_data.email){send_ct_carrotquest('Заявка из popup-формы Carrotquest',ct_data);}
                            }
                        });
                    }
                });
            });
        </script>

        <script id="advcakeAsync">
            // метрики advcake
            window.addEventListener('CruisesSearchResult', function(event) {
                window.advcake_data.push({
                    pageType: 5,
                    leads: event.detail.map(item => ({ id: item.id, name: item.title, totalPrice: item.discount_price }))
                });
            }, false);
            window.addEventListener('CruiseDetailPage', function(event) {
                window.advcake_data.push({ pageType: 2, currentLead: { id: event.detail.id, name: event.detail.title } });
            }, false);
            window.addEventListener('OrderingPage', function(event) {
                if (!event.detail.order) return;
                for (const order of event.detail.order) {
                    window.advcake_data.push({ pageType: 3, currentLead: { id: order.cruiseID, name: order.name } });
                    break; // руизов может быть несколько, но цена общая, отправляем только один
                }
            }, false);
            window.addEventListener('OrderIsCreated', function(event) {
                if (!event.detail.order) return;
                for (const order of event.detail.order) {
                    window.advcake_data.push({
                        pageType: 6,
                        leadInfo: {
                            id: event.detail.result.order_id,
                            leadid: order.cruiseID,
                            name: order.name,
                            totalPrice: event.detail.price.total
                        }
                    });
                    break; // руизов может быть несколько, но цена общая, отправляем только один
                }
            }, false);
            // авторизация/регистрация
            window.addEventListener('LoginFormSent', function(event) {
                window.advcake_data.push({
                    pageType: 6,
                    leadInfo: {
                        id: event.detail.phone,
                        leadid: null,
                        name: 'Регистрация',
                        totalPrice: 0
                    }
                });
            });
            // Отправка формы обратного звонка
            window.addEventListener('CallbackFormSent', function(event) {
                window.advcake_data.push({
                    pageType: 6,
                    leadInfo: {
                        id: event.detail.phone,
                        leadid: null,
                        name: 'Обратный звонок',
                        totalPrice: 0
                    }
                });
            });
            // Отправка формы обратного звонка
            window.addEventListener('IWantToCruiseFormSent', function(event) {
                if (event.detail) {
                    if (event.detail.url !== '/kruiz-na-soloveckie-ostrova-iz-moskvy-v-2022-gody') {
                        window.advcake_data.push({
                            pageType: 6,
                            leadInfo: {
                                id: event.detail.phone,
                                leadid: null,
                                name: 'Обратный звонок',
                                totalPrice: 0
                            }
                        });
                    }
                }
                return true;
            });
            // быстрая бронь
            window.addEventListener('ModalFastBuyFormSent', function(event) {
                window.advcake_data.push({
                    pageType: 6,
                    leadInfo: {
                        id: event.detail.phone,
                        leadid: null,
                        name: 'Быстрый заказ',
                        totalPrice: 0
                    }
                });
            });
            // Форма: Сложно выбрать? Наш эксперт поможет Вам
            window.addEventListener('ICannotChoose', function(event) {
                window.advcake_data.push({
                    pageType: 6,
                    leadInfo: {
                        id: event.detail.phone,
                        leadid: null,
                        name: 'Быстрый заказ',
                        totalPrice: 0
                    }
                });
            });
            // хочу в круиз
            window.addEventListener('IWantToCruiseFormSent', function(event) {
                window.advcake_data.push({
                    pageType: 6,
                    leadInfo: {
                        id: event.detail.phone,
                        leadid: null,
                        name: 'Быстрый заказ',
                        totalPrice: 0
                    }
                });
            });
        </script>
    <% } %>
</body>
</html>
